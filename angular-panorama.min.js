/**
 * Angular Panorama - Mimic Windows Phone's Panorama UI control.
 * @version v0.1.5 - 2014-03-12
 * @link http://cnjsstong2.github.com/angular-panorama
 * @author Tong Shen <tshen@farseerinc.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-panorama",["ngTouch"]),angular.module("angular-panorama").directive("ngPanoramaNative",["$swipe","$document","$window",function(a){return{restrict:"A",scope:{pages:"=ngPanoramaNative",curIndex:"=ngPanoramaIndex",backgroundImage:"=ngPanoramaBackgroundImage",reset:"=ngPanoramaReset"},link:function(b,c){function d(a){for(var d=0,e=c.prop("offsetWidth"),f=0;a>f;f++)d-=(b.pages[f].width||100)*e/100;if(a>0){var g=(100-b.pages[a].width)/2*e/100;d+=g,a==b.pages.length-1&&(d+=g)}return console.log(d),d}function e(a){f.css({"-webkit-transform":"translate3d("+a+"px, 0, 0)",transform:"translate3d("+a+"px, 0, 0)"})}b.$watch("backgroundImage",function(a){c.css("background-image","url("+a+")")}),b.$watch("curIndex",function(){e(d(b.curIndex))}),b.$watch("reset",function(){f.css(j),e(0),f.css(i)}),console.log(c),c.addClass("ng-panorama-container");var f=c.find("ul");f.addClass("ng-panorama-slides"),b.curIndex||(b.curIndex=0);var g,h,i={transition:"all 0.2s ease-in"},j={transition:"none"};a.bind(c,{start:function(a){console.log("start: ",a),g=a,h=d(b.curIndex),f.css(j)},move:function(a){e(h+a.x-g.x)},end:function(a){console.log("end: ",a);var h=b.curIndex,j=.12*c.prop("offsetWidth"),k=a.x-g.x;console.log(k,j),k>j&&h>0?h--:-j>k&&h<b.pages.length-1&&h++,console.log(b.curIndex,h),b.$apply(function(){b.curIndex=h}),f.css(i),e(d(b.curIndex))},cancel:function(a){console.log("cancel: ",a),f.css(i),e(d(b.curIndex))}})}}}]),angular.module("angular-panorama").directive("ngPanorama",["$compile","$parse","$swipe","$document","$window","CollectionManager",function(a,b,c,d,e,f){var g=0;return{restrict:"A",scope:!0,compile:function(h,i){h.addClass("ng-panorama-slides");for(var j,k=h.children("li"),l=0;l<k.length;l++)k[l].attributes["ng-repeat"]&&(j=k[l]);var m,n,o=j.attributes,p=o["ng-repeat"],q=!1;if(p||(p=o["data-ng-repeat"]),p||(p=o["x-ng-repeat"]),p){var r=p.value.match(/^\s*(.+)\s+in\s+(.*?)\s*(\s+track\s+by\s+(.+)\s*)?$/),s=r[1],t=r[3]||"";m=r[2],q=angular.isDefined(i.ngPanoramaBuffered),p.value=s+" in panoramaCollection.cards "+t}else{var u=h.children("li");if(u.length<2)throw new Error("panorama: cannot find the ngRepeat attribute OR no childNodes detected");m="fakeArray",n=Array.prototype.slice.apply(u)}return function(h,i,j){function k(){var a=e.innerHeight;j.minHeightOffset&&(a+=parseInt(j.minHeightOffset)),K.css("min-height",a+"px")}function l(a){var b=angular.element(a).css("transform").match(/translate3d\((-?\d+(?:px)?),\s*(-?\d+(?:px)?),\s*(-?\d+(?:px)?)\)/);return b?b.slice(1,3):[0,0,0]}function o(a){!a.target||a.target!==J[0]||"transform"!==a.propertyName&&"-webkit-transform"!==a.propertyName&&"-moz-transform"!==a.propertyName||(h.$apply(function(){s(),h.panoramaCollection.adjustBuffer(),x(!0)}),J.css(u(l(J[0]),!0)))}function p(a,b){function c(){I=!0,h.panoramaCollection[a](b,!0)}h.$$phase?c():h.$apply(c)}function r(a,b){var c="after"===a?"push":"unshift";b&&(angular.isObject(b.promise)?b.promise.then(function(a){a&&p(c,a)}):angular.isFunction(b.then)?b.then(function(a){a&&p(c,a)}):p(c,b))}function s(){var a=h.panoramaCollection.position,c=h.panoramaCollection.getLastIndex(),d=null;0===a&&angular.isDefined(j.ngPanoramaPrev)&&(d=b(j.ngPanoramaPrev)(h,{item:h.panoramaCollection.cards[0]}),r("before",d)),a===c&&angular.isDefined(j.ngPanoramaNext)&&(d=b(j.ngPanoramaNext)(h,{item:h.panoramaCollection.cards[h.panoramaCollection.cards.length-1]}),r("after",d))}function t(a,b){var c={};return c[a]=b,angular.forEach(Q,function(d){c["-"+d.toLowerCase()+"-"+a]=b}),c}function u(a,b){return b?t("transform","translate3d("+a+"px,0,0)"):t("transform","translate("+a+"px,0)")}function v(){w(),x(),k()}function w(){K.css("width","auto"),I=!0;var a=J.children("li");H=0===a.length?J[0].getBoundingClientRect().width:a[0].getBoundingClientRect().width;var b=H;return h.panoramaCollection.cards[0]&&h.panoramaCollection.cards[0].width&&(b=100*b/h.panoramaCollection.cards[0].width),K.css("width",b+"px"),b}function x(a){I=!!a||I,0===H&&w(),F=Math.round(h.panoramaCollection.getOffsetWithWidth(h.panoramaCollection.getRelativeIndex())*H/100),I===!0?J.removeClass("ng-panorama-animate").addClass("ng-panorama-noanimate").css(u(F,!1)):J.removeClass("ng-panorama-noanimate").addClass("ng-panorama-animate").css(u(F,!0)),I=!1}function y(a){if(d.unbind("mouseup",A),0===H&&w(),C>1){var b=h.panoramaCollection.getLastIndex(),c=h.panoramaCollection.position,e=E>F?1:-1,f=Math.min(Math.max(0,c+e),b),g=a.x-D;Math.abs(g)<=H*G&&(f=c);var i=c!==f;h.$apply(i?function(){angular.isDefined(j.ngPanoramaCycle)&&(h.panoramaCollection.position=f,x());var a=f/b*100;K.css("background-position",a+"% 50%"),h.panoramaCollection.goTo(f,!0)}:function(){x()})}C=0}function z(a){var b=K[0].getBoundingClientRect(),c=a.x>b.left&&a.x<b.left+H&&a.y>b.top&&a.y<b.top+b.height;return c}function A(a){y({x:a.clientX,y:a.clientY})}g++;var B="ng-panorama-"+g,C=0,D=0,E=0,F=0,G=.1,H=0,I=!0,J=i.wrap("<div id='"+B+"' class='ng-panorama-container'></div>"),K=J.parent();k(),n&&(h.fakeArray=n),h.$watch("originalCollection");var L=b(m),M={},N=0;if(j.ngPanoramaIndex){var O=b(j.ngPanoramaIndex);angular.isFunction(O.assign)?(h.$watch("panoramaCollection.index",function(a){O.assign(h.$parent,a)}),N=O(h),h.$parent.$watch(O,function(a){void 0!==a&&h.panoramaCollection.goToIndex(a,!0)})):isNaN(j.ngPanoramaIndex)||(N=parseInt(j.ngPanoramaIndex,10))}angular.isDefined(j.ngPanoramaCycle)&&(M.cycle=!0),M.index=N,q&&(M.bufferSize=3,M.buffered=!0),h.panoramaCollection=f.create(M),h.$watch("panoramaCollection.updated",function(a){a&&x()});var P=!1;h.$watch(L,function(a){h.panoramaCollection.setItems(a,P),P=!0,0===H&&w(),x()}),angular.isDefined(j.ngPanoramaWatch)&&h.$watch(m,function(a){h.panoramaCollection.setItems(a,!1),P=!0,0===H&&w(),x()},!0);var Q=["webkit","moz"];if(J[0].addEventListener("webkitTransitionEnd",o,!1),J[0].addEventListener("transitionend",o,!1),window.addEventListener("orientationchange",v),window.addEventListener("resize",v),angular.isDefined(j.ngPanoramaBackgroundImage)&&(K.css("background-image","url("+j.ngPanoramaBackgroundImage+")"),K.css("background-position","0% 50%")),j.$observe("ngPanoramaBackgroundImage",function(a){a&&(K.css("background-image","url("+a+")"),K.css("background-position",h.panoramaCollection.position/h.panoramaCollection.lastIndex*100+"% 50%"))}),angular.isDefined(j.ngPanoramaIndicator)){var R=a("<div id='"+B+"-indicator' index='panoramaCollection.index' items='panoramaCollection.items' data-ng-panorama-indicators class='ng-panorama-indicator'></div>")(h);K.append(R)}var S=null,T=e.jasmine||"iPad"==e.navigator.platform?0:50;c.bind(J,{start:function(a){0===C&&(C=1,D=a.x),d.bind("mouseup",A)},move:function(a){if(!z(a))return void y(a);if(0!==C){var b=a.x-D;if(1===C&&0!==b)C=2,E=F;else if(2===C){var c=(new Date).getTime();if(S&&T>c-S)return;S=c;var d=h.panoramaCollection.getLastIndex(),e=h.panoramaCollection.position,f=1;(0===e&&a.x>D||e===d&&a.x<D)&&(f=3),F=E+b/f,J.css(u(F,!0)).removeClass("ng-panorama-animate").addClass("ng-panorama-noanimate")}}},end:function(a){y(a)}})}}}}]),angular.module("angular-panorama").service("CollectionManager",[function(){function a(a){var b,c={bufferSize:0,bufferStart:0,buffered:!1,cycle:!1,cycleOffset:0,index:0,position:0,items:[],cards:[],updated:null,debug:!1};if(a)for(b in a)c[b]=a[b];for(b in c)this[b]=c[b];angular.extend(this,c,a),this.init()}return a.prototype.log=function(){this.debug&&console.log.apply(console,arguments)},a.prototype.getPositionFromIndex=function(a){return(a+this.cycleOffset)%this.length()},a.prototype.goToIndex=function(a,b){if(a=Math.max(0,Math.min(a,this.getLastIndex())),this.updated&&a===this.index)return this.log("skip position change(same)"),!1;var c=this.getPositionFromIndex(a);return this.goTo(c,b)},a.prototype.goTo=function(a,b){if(this.log("goto start",a,b),0===this.length())return void this.log("empty, skip gotoIndex");a=Math.max(0,Math.min(a,this.getLastIndex()));var c=!1;this.cycle&&(0===a?(this.log("cycleAtBeginning",a),this.cycleAtBeginning(),a=1,this.cycleOffset++,c=!0):a===this.getLastIndex()&&(this.log("cycleAtEnd",a),this.cycleAtEnd(),a--,this.cycleOffset--,c=!0),this.cycleOffset%=this.length()),this.position=Math.max(0,Math.min(a,this.getLastIndex()));var d=(this.position-this.cycleOffset+this.length())%this.length();this.index=Math.max(0,Math.min(d,this.getLastIndex())),b||this.adjustBuffer(),c||(this.updated=new Date)},a.prototype.next=function(){this.goTo(this.cycle?(this.position+1)%this.length():Math.min(this.position+1,this.getLastIndex()))},a.prototype.prev=function(){if(this.cycle)this.goTo((this.position-1+this.length())%this.length());else{var a=this.length()>0?Math.max(0,(this.position-1)%this.length()):0;this.goTo(a)}},a.prototype.setBufferSize=function(a){this.log("setBufferSize",a),this.bufferSize=a,this.adjustBuffer()},a.prototype.isBuffered=function(){return this.buffered},a.prototype.getRelativeIndex=function(){var a=Math.max(0,Math.min(this.getLastIndex(),this.position-this.bufferStart));return a},a.prototype.adjustBuffer=function(){var a=(this.getLastIndex()+1-this.bufferSize)%this.length();this.log("maxBufferStart",a),this.bufferStart=Math.max(0,Math.min(a,this.position-1)),this.cards=this.items.slice(this.bufferStart,this.bufferStart+this.bufferSize),this.log("adjustBuffer from",this.bufferStart,"to",this.bufferStart+this.bufferSize)},a.prototype.length=function(){return this.items.length},a.prototype.getLastIndex=function(){var a=Math.max(0,this.length()-1);return a},a.prototype.init=function(){this.setBufferSize(this.isBuffered()?this.bufferSize:this.length()),this.length()>0&&this.goToIndex(this.index)},a.prototype.setItems=function(a,b){this.log("setItems",a,b),b&&(this.index=0,this.position=0),this.items=a||[],this.init()},a.prototype.cycleAtEnd=function(){this.push(this.items.shift())},a.prototype.push=function(a,b){this.log("push item(s)",a,b),this.items.push(a),b&&(this.adjustBuffer(),this.updated=new Date),this.buffered||this.bufferSize++},a.prototype.unshift=function(a,b){this.log("unshift item(s)",a,b),this.items.unshift(a),this.buffered||this.bufferSize++,b&&(this.position++,this.adjustBuffer(),this.updated=new Date)},a.prototype.cycleAtBeginning=function(){this.unshift(this.items.pop())},a.prototype.getOffsetWithWidth=function(a){if(this.items[0]&&this.items[0].width){var b=0,c=this.index;if(0==c)return 0;for(var d in this.cards.slice(0,a))b+=this.cards[d].width;return b-=c<this.items.length-1?(100-this.cards[a].width)/2:100-this.cards[a].width,-b}return-a},{create:function(b){return new a(b)}}}]);