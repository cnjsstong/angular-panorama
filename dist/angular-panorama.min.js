/**
 * Angular Panorama - Mimic Windows Phone's Panorama UI control.
 * @version v0.1.0 - 2013-12-26
 * @link http://cnjsstong2.github.com/angular-panorama
 * @author Tong Shen <tshen@farseerinc.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-panorama",["ngTouch"]),angular.module("angular-panorama").directive("ngPanoramaIndicators",[function(){return{restrict:"A",replace:!0,scope:{items:"=",index:"="},template:'<div class="ng-panorama-indicator"><span ng-repeat="item in items" ng-class="{active: $index==$parent.index}">‚óè</span></div>'}}]),angular.module("angular-panorama").directive("ngPanoramaInfinite",["$parse","$compile",function(a){return{restrict:"EA",transclude:!0,replace:!0,scope:!0,template:"<ul ng-panorama ng-panorama-buffered><li ng-transclude></li></ul>",compile:function(b,c){var d=c.rnpanoramaCurrent+" in items";return b.children("li").attr("ng-repeat",d),function(b,c,d){b.items=[a(d.rnpanoramaCurrent)(b)],b.$watchCollection("panoramaCollection.position",function(c){a(d.rnpanoramaCurrent).assign(b.$parent,b.items[c])})}}}}]),angular.module("angular-panorama").directive("ngPanorama",["$compile","$parse","$swipe","$document","$window","CollectionManager",function(a,b,c,d,e,f){var g=0;return{restrict:"A",scope:!0,compile:function(h,i){h.addClass("ng-panorama-slides");var j,k,l=h.children("li")[0].attributes,m=l["ng-repeat"],n=!1;if(m||(m=l["data-ng-repeat"]),m||(m=l["x-ng-repeat"]),m){var o=m.value.match(/^\s*(.+)\s+in\s+(.*?)\s*(\s+track\s+by\s+(.+)\s*)?$/),p=o[1],q=o[3]||"";j=o[2],n=angular.isDefined(i.rnpanoramaBuffered),m.value=p+" in panoramaCollection.cards "+q}else{var r=h.children("li");if(r.length<2)throw new Error("panorama: cannot find the ngRepeat attribute OR no childNodes detected");j="fakeArray",k=Array.prototype.slice.apply(r)}return function(h,i,l){function m(a){var b=angular.element(a).css("transform").match(/translate3d\((-?\d+(?:px)?),\s*(-?\d+(?:px)?),\s*(-?\d+(?:px)?)\)/);return b?b.slice(1,3):[0,0,0]}function o(a){!a.target||a.target!==I[0]||"transform"!==a.propertyName&&"-webkit-transform"!==a.propertyName&&"-moz-transform"!==a.propertyName||(h.$apply(function(){r(),h.panoramaCollection.adjustBuffer(),w(!0)}),I.css(t(m(I[0]),!0)))}function p(a,b){function c(){H=!0,h.panoramaCollection[a](b,!0)}h.$$phase?c():h.$apply(c)}function q(a,b){var c="after"===a?"push":"unshift";b&&(angular.isObject(b.promise)?b.promise.then(function(a){a&&p(c,a)}):angular.isFunction(b.then)?b.then(function(a){a&&p(c,a)}):p(c,b))}function r(){var a=h.panoramaCollection.position,c=h.panoramaCollection.getLastIndex(),d=null;0===a&&angular.isDefined(l.rnpanoramaPrev)&&(d=b(l.rnpanoramaPrev)(h,{item:h.panoramaCollection.cards[0]}),q("before",d)),a===c&&angular.isDefined(l.rnpanoramaNext)&&(d=b(l.rnpanoramaNext)(h,{item:h.panoramaCollection.cards[h.panoramaCollection.cards.length-1]}),q("after",d))}function s(a,b){var c={};return c[a]=b,angular.forEach(P,function(d){c["-"+d.toLowerCase()+"-"+a]=b}),c}function t(a,b){return b?s("transform","translate3d("+a+"px,0,0)"):s("transform","translate("+a+"px,0)")}function u(){v(),w()}function v(){J.css("width","auto"),H=!0;var a=I.children("li");return G=0===a.length?I[0].getBoundingClientRect().width:a[0].getBoundingClientRect().width,J.css("width",G+"px"),G}function w(a){H=!!a||H,0===G&&v(),E=Math.round(h.panoramaCollection.getRelativeIndex()*-G),H===!0?I.removeClass("ng-panorama-animate").addClass("ng-panorama-noanimate").css(t(E,!1)):I.removeClass("ng-panorama-noanimate").addClass("ng-panorama-animate").css(t(E,!0)),H=!1}function x(a){if(d.unbind("mouseup",z),0===G&&v(),B>1){var b=h.panoramaCollection.getLastIndex(),c=h.panoramaCollection.position,e=D>E?1:-1,f=Math.min(Math.max(0,c+e),b),g=a.x-C;Math.abs(g)<=G*F&&(f=c);var i=c!==f;i?h.$apply(function(){angular.isDefined(l.rnpanoramaCycle)&&(h.panoramaCollection.position=f,w()),h.panoramaCollection.goTo(f,!0)}):h.$apply(function(){w()})}B=0}function y(a){var b=J[0].getBoundingClientRect(),c=a.x>b.left&&a.x<b.left+G&&a.y>b.top&&a.y<b.top+b.height;return c}function z(a){x({x:a.clientX,y:a.clientY})}g++;var A="ng-panorama-"+g,B=0,C=0,D=0,E=0,F=.1,G=0,H=!0,I=i.wrap("<div id='"+A+"' class='ng-panorama-container'></div>"),J=I.parent();k&&(h.fakeArray=k);var K=b(j),L={},M=0;if(l.rnpanoramaIndex){var N=b(l.rnpanoramaIndex);angular.isFunction(N.assign)?(h.$watch("panoramaCollection.index",function(a){N.assign(h.$parent,a)}),M=N(h),h.$parent.$watch(N,function(a){void 0!==a&&h.panoramaCollection.goToIndex(a,!0)})):isNaN(l.rnpanoramaIndex)||(M=parseInt(l.rnpanoramaIndex,10))}angular.isDefined(l.rnpanoramaCycle)&&(L.cycle=!0),L.index=M,n&&(L.bufferSize=3,L.buffered=!0),h.panoramaCollection=f.create(L),h.$watch("panoramaCollection.updated",function(a){a&&w()});var O=!1;h.$watch(K,function(a){h.panoramaCollection.setItems(a,O),O=!0,0===G&&v(),w()}),angular.isDefined(l.rnpanoramaWatch)&&h.$watch(j,function(a){h.panoramaCollection.setItems(a,!1),O=!0,0===G&&v(),w()},!0);var P=["webkit","moz"];if(I[0].addEventListener("webkitTransitionEnd",o,!1),I[0].addEventListener("transitionend",o,!1),window.addEventListener("orientationchange",u),window.addEventListener("resize",u),angular.isDefined(l.rnpanoramaIndicator)){var Q=a("<div id='"+A+"-indicator' index='panoramaCollection.index' items='panoramaCollection.items' data-ng-panorama-indicators class='ng-panorama-indicator'></div>")(h);J.append(Q)}var R=null,S=e.jasmine||"iPad"==e.navigator.platform?0:50;c.bind(I,{start:function(a){0===B&&(B=1,C=a.x),d.bind("mouseup",z)},move:function(a){if(!y(a))return x(a),void 0;if(0!==B){var b=a.x-C;if(1===B&&0!==b)B=2,D=E;else if(2===B){var c=(new Date).getTime();if(R&&S>c-R)return;R=c;var d=h.panoramaCollection.getLastIndex(),e=h.panoramaCollection.position,f=1;(0===e&&a.x>C||e===d&&a.x<C)&&(f=3),E=D+b/f,I.css(t(E,!0)).removeClass("ng-panorama-animate").addClass("ng-panorama-noanimate")}}},end:function(a){x(a)}})}}}}]),angular.module("angular-panorama").service("CollectionManager",[function(){function a(a){var b,c={bufferSize:0,bufferStart:0,buffered:!1,cycle:!1,cycleOffset:0,index:0,position:0,items:[],cards:[],updated:null,debug:!1};if(a)for(b in a)c[b]=a[b];for(b in c)this[b]=c[b];angular.extend(this,c,a),this.init()}return a.prototype.log=function(){this.debug&&console.log.apply(console,arguments)},a.prototype.getPositionFromIndex=function(a){return(a+this.cycleOffset)%this.length()},a.prototype.goToIndex=function(a,b){if(a=Math.max(0,Math.min(a,this.getLastIndex())),this.updated&&a===this.index)return this.log("skip position change(same)"),!1;var c=this.getPositionFromIndex(a);return this.goTo(c,b)},a.prototype.goTo=function(a,b){if(this.log("goto start",a,b),0===this.length())return this.log("empty, skip gotoIndex"),void 0;a=Math.max(0,Math.min(a,this.getLastIndex()));var c=!1;this.cycle&&(0===a?(this.log("cycleAtBeginning",a),this.cycleAtBeginning(),a=1,this.cycleOffset++,c=!0):a===this.getLastIndex()&&(this.log("cycleAtEnd",a),this.cycleAtEnd(),a--,this.cycleOffset--,c=!0),this.cycleOffset%=this.length()),this.position=Math.max(0,Math.min(a,this.getLastIndex()));var d=(this.position-this.cycleOffset+this.length())%this.length();this.index=Math.max(0,Math.min(d,this.getLastIndex())),b||this.adjustBuffer(),c||(this.updated=new Date)},a.prototype.next=function(){this.cycle?this.goTo((this.position+1)%this.length()):this.goTo(Math.min(this.position+1,this.getLastIndex()))},a.prototype.prev=function(){if(this.cycle)this.goTo((this.position-1+this.length())%this.length());else{var a=this.length()>0?Math.max(0,(this.position-1)%this.length()):0;this.goTo(a)}},a.prototype.setBufferSize=function(a){this.log("setBufferSize",a),this.bufferSize=a,this.adjustBuffer()},a.prototype.isBuffered=function(){return this.buffered},a.prototype.getRelativeIndex=function(){var a=Math.max(0,Math.min(this.getLastIndex(),this.position-this.bufferStart));return a},a.prototype.adjustBuffer=function(){var a=(this.getLastIndex()+1-this.bufferSize)%this.length();this.log("maxBufferStart",a),this.bufferStart=Math.max(0,Math.min(a,this.position-1)),this.cards=this.items.slice(this.bufferStart,this.bufferStart+this.bufferSize),this.log("adjustBuffer from",this.bufferStart,"to",this.bufferStart+this.bufferSize)},a.prototype.length=function(){return this.items.length},a.prototype.getLastIndex=function(){var a=Math.max(0,this.length()-1);return a},a.prototype.init=function(){this.setBufferSize(this.isBuffered()?this.bufferSize:this.length()),this.length()>0&&this.goToIndex(this.index)},a.prototype.setItems=function(a,b){this.log("setItems",a,b),b&&(this.index=0,this.position=0),this.items=a||[],this.init()},a.prototype.cycleAtEnd=function(){this.push(this.items.shift())},a.prototype.push=function(a,b){this.log("push item(s)",a,b),this.items.push(a),b&&(this.adjustBuffer(),this.updated=new Date),this.buffered||this.bufferSize++},a.prototype.unshift=function(a,b){this.log("unshift item(s)",a,b),this.items.unshift(a),this.buffered||this.bufferSize++,b&&(this.position++,this.adjustBuffer(),this.updated=new Date)},a.prototype.cycleAtBeginning=function(){this.unshift(this.items.pop())},{create:function(b){return new a(b)}}}]);